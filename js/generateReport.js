var DATA = [
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150303","horacompra":"1000"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150303","horacompra":"1000"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":4,"valorunitario":70,"datacompra":"20150303","horacompra":"1015"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150303","horacompra":"1020"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":2,"valorunitario":70,"datacompra":"20150303","horacompra":"1103"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":4,"valorunitario":70,"datacompra":"20150303","horacompra":"1110"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":4,"valorunitario":70,"datacompra":"20150304","horacompra":"1223"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150304","horacompra":"2130"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":2,"valorunitario":70,"datacompra":"20150304","horacompra":"0838"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":5,"valorunitario":70,"datacompra":"20150304","horacompra":"1536"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":2,"valorunitario":70,"datacompra":"20150304","horacompra":"1422"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150305","horacompra":"1145"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":2,"valorunitario":70,"datacompra":"20150305","horacompra":"0742"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150305","horacompra":"2330"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":4,"valorunitario":70,"datacompra":"20150307","horacompra":"0034"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150307","horacompra":"1630"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150307","horacompra":"1015"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":6,"valorunitario":70,"datacompra":"20150307","horacompra":"0922"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150308","horacompra":"0800"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":2,"valorunitario":70,"datacompra":"20150310","horacompra":"1537"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":4,"valorunitario":70,"datacompra":"20150310","horacompra":"1250"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150310","horacompra":"1120"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150312","horacompra":"1005"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":1,"valorunitario":70,"datacompra":"20150312","horacompra":"1732"},
	{"evento":"Evento 1","categoria":"cadeira","quantidade":3,"valorunitario":70,"datacompra":"20150315","horacompra":"1423"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150303","horacompra":"0834"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150303","horacompra":"2023"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":4,"valorunitario":100,"datacompra":"20150303","horacompra":"1905"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150303","horacompra":"1110"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150303","horacompra":"1732"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150304","horacompra":"1423"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":4,"valorunitario":100,"datacompra":"20150304","horacompra":"0922"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":6,"valorunitario":100,"datacompra":"20150304","horacompra":"0922"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150305","horacompra":"1120"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150305","horacompra":"1110"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":4,"valorunitario":100,"datacompra":"20150305","horacompra":"2130"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150305","horacompra":"1015"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150306","horacompra":"1423"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150306","horacompra":"0742"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":4,"valorunitario":100,"datacompra":"20150306","horacompra":"0922"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150306","horacompra":"0742"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":4,"valorunitario":100,"datacompra":"20150307","horacompra":"1145"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150307","horacompra":"2330"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150307","horacompra":"1522"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150318","horacompra":"1534"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150318","horacompra":"2330"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":1,"valorunitario":100,"datacompra":"20150318","horacompra":"1645"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":2,"valorunitario":100,"datacompra":"20150320","horacompra":"1759"},
	{"evento":"Evento 1","categoria":"camarote","quantidade":3,"valorunitario":100,"datacompra":"20150320","horacompra":"1423"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":4,"valorunitario":80,"datacompra":"20150312","horacompra":"0017"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":5,"valorunitario":80,"datacompra":"20150312","horacompra":"0032"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150312","horacompra":"0845"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":2,"valorunitario":80,"datacompra":"20150312","horacompra":"1712"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":3,"valorunitario":80,"datacompra":"20150314","horacompra":"1315"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":4,"valorunitario":80,"datacompra":"20150314","horacompra":"1423"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":5,"valorunitario":80,"datacompra":"20150314","horacompra":"1145"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150314","horacompra":"1423"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":2,"valorunitario":80,"datacompra":"20150315","horacompra":"1534"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":3,"valorunitario":80,"datacompra":"20150315","horacompra":"1534"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150315","horacompra":"1145"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":4,"valorunitario":80,"datacompra":"20150315","horacompra":"2330"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150317","horacompra":"1120"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":2,"valorunitario":80,"datacompra":"20150317","horacompra":"1120"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":3,"valorunitario":80,"datacompra":"20150317","horacompra":"1534"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150318","horacompra":"2330"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":4,"valorunitario":80,"datacompra":"20150318","horacompra":"1830"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":5,"valorunitario":80,"datacompra":"20150322","horacompra":"1830"},
	{"evento":"Evento 2","categoria":"cadeira","quantidade":1,"valorunitario":80,"datacompra":"20150322","horacompra":"1110"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":2,"valorunitario":120,"datacompra":"20150327","horacompra":"0650"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":3,"valorunitario":120,"datacompra":"20150312","horacompra":"1110"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":4,"valorunitario":120,"datacompra":"20150312","horacompra":"1840"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":1,"valorunitario":120,"datacompra":"20150314","horacompra":"1110"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":2,"valorunitario":120,"datacompra":"20150314","horacompra":"2150"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":1,"valorunitario":120,"datacompra":"20150319","horacompra":"1917"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":4,"valorunitario":120,"datacompra":"20150319","horacompra":"2022"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":2,"valorunitario":120,"datacompra":"20150319","horacompra":"2048"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":1,"valorunitario":120,"datacompra":"20150316","horacompra":"2119"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":4,"valorunitario":120,"datacompra":"20150316","horacompra":"1015"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":5,"valorunitario":120,"datacompra":"20150316","horacompra":"1533"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":1,"valorunitario":120,"datacompra":"20150320","horacompra":"1640"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":2,"valorunitario":120,"datacompra":"20150320","horacompra":"1015"},
	{"evento":"Evento 2","categoria":"camarote","quantidade":3,"valorunitario":120,"datacompra":"20150320","horacompra":"2250"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":4,"valorunitario":100,"datacompra":"20150320","horacompra":"2217"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150321","horacompra":"2350"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":2,"valorunitario":100,"datacompra":"20150321","horacompra":"1449"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":3,"valorunitario":100,"datacompra":"20150321","horacompra":"1423"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":4,"valorunitario":100,"datacompra":"20150321","horacompra":"1015"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":2,"valorunitario":100,"datacompra":"20150324","horacompra":"1408"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":3,"valorunitario":100,"datacompra":"20150324","horacompra":"0927"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150324","horacompra":"1930"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":4,"valorunitario":100,"datacompra":"20150324","horacompra":"1015"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150328","horacompra":"0925"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":4,"valorunitario":100,"datacompra":"20150328","horacompra":"0927"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":5,"valorunitario":100,"datacompra":"20150328","horacompra":"1126"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150328","horacompra":"1033"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":2,"valorunitario":100,"datacompra":"20150329","horacompra":"0927"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":3,"valorunitario":100,"datacompra":"20150329","horacompra":"2230"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150329","horacompra":"2320"},
	{"evento":"Evento 2","categoria":"poltrona","quantidade":1,"valorunitario":100,"datacompra":"20150330","horacompra":"1157"}
]

var w = window,
    d = document,
    e = d.documentElement,
    g = d.getElementById('panel-report'),
    x = w.innerWidth || e.clientWidth || g.clientWidth,
    y = w.innerHeight|| e.clientHeight|| g.clientHeight;

// Set margins
var margin = {
    top: 20,
    right: 20,
    bottom: 100,
    left: 60
},
width = (x - margin.left - margin.right) * 0.6,
height = (y - margin.top - margin.bottom) * 0.4;

var parseDate = d3.time.format("%Y%m%d").parse;

// Set x scale
var x = d3.scale.ordinal().rangeRoundBands([0, width], .2);

// Set y scale
var y = d3.scale.linear().rangeRound([height, 0]);

// Set axis
var xAxis = d3.svg.axis()
  .scale(x)
  .orient("bottom")
  .tickFormat(d3.time.format("%d/%m/%Y"));

var yAxis = d3.svg.axis()
  .scale(y)
  .orient("left");

// Add chart
var svg = d3.select("#viz")
  .append("svg")
    .attr("id", "id-svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var nest = d3.nest()
      .key(function(d) { return d.datacompra; })
      .sortKeys(d3.ascending)
      .rollup(function(values) {
        return {
          totalQuantidade: d3.sum(values, function(d) { return d.quantidade }),
          totalValor: d3.sum(values, function(d) { return d.valorunitario * d.quantidade })
        };
      })
      .entries(DATA);

console.log(nest.filter(function(d) {return d.key < 20150318;}));

// Set domain
x.domain(nest.map(function (d) {
    return parseDate(d.key);
}));

y.domain([0, d3.max(nest, function (d) {
    return d.values.totalQuantidade + 10;
})]);

// Apply domain to Axis
svg.append("g")
  .attr("class", "axis")
  .attr("transform", "translate(0," + (height) + ")")
  .call(xAxis)
  .selectAll("text")	
    .style("text-anchor", "end")
    .attr("dx", "-.8em")
    .attr("dy", ".15em")
    .attr("transform", function(d) {
      return "rotate(-65)" 
    });

svg.append("g")
  .attr("class", "axis")
  .call(yAxis)
  .append("text")
  //.attr("transform", "rotate(-90)")
  .attr("x", 130)
  .attr("dy", ".71em")
  .style("text-anchor", "end")
  .text("Quantidade de Ingressos");

// Draw data
svg.selectAll(".data")
    .data(nest)
    .enter()
    .append("g")
      .attr("class", "g")
      .attr("transform", function (d) {
        return "translate(" + x(parseDate(d.key)) + ",0)";
      })
    .append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function (d) {
        return y(d.values.totalQuantidade);
      })
      .attr("height", function (d) {
        return y(0) - y(d.values.totalQuantidade);
      })
      .style("fill","#e67e22")
      .style("opacity", 0.7)
    .append("title")
      .text(function(d) {return d.values.totalValor.format(2, 3, '.', ',');});